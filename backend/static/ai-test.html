<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AlwaysSunny ‚Äî AI Test Bench</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      background: #0f1923;
      color: #e0e8f0;
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
      font-size: 14px;
    }
    h1 { color: #f5c518; font-size: 20px; margin-bottom: 4px; }
    .subtitle { color: #6b8299; font-size: 12px; margin-bottom: 24px; }
    .section { margin-bottom: 20px; }
    .section-title {
      color: #8da4be;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 8px;
      border-bottom: 1px solid #1e2d40;
      padding-bottom: 4px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
      color: #6b8299;
    }
    input, select {
      background: #162030;
      border: 1px solid #2a3f57;
      color: #e0e8f0;
      padding: 6px 10px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #f5c518;
    }
    .btn-row { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    button {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary { background: #f5c518; color: #0f1923; }
    .btn-primary:hover { background: #e0b400; }
    .btn-primary:disabled { opacity: 0.5; cursor: wait; }
    .btn-secondary { background: #1e2d40; color: #8da4be; border: 1px solid #2a3f57; }
    .btn-secondary:hover { border-color: #f5c518; color: #f5c518; }
    .btn-danger { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }

    /* Result sections */
    .result-card {
      background: #162030;
      border: 1px solid #2a3f57;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .result-card.highlight {
      border-color: #f5c518;
      background: rgba(245, 197, 24, 0.04);
    }
    .result-card.command {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.04);
    }
    .result-card.banner {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.04);
    }
    .result-label {
      font-size: 11px;
      color: #6b8299;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }
    .result-value {
      font-size: 15px;
      font-weight: 700;
    }
    .result-value.amps { color: #f5c518; font-size: 28px; }
    .result-value.confidence-high { color: #22c55e; }
    .result-value.confidence-medium { color: #f59e0b; }
    .result-value.confidence-low { color: #ef4444; }
    .reasoning {
      font-style: italic;
      color: #c0d0e0;
      font-size: 14px;
      line-height: 1.6;
      margin-top: 4px;
    }
    .command-text {
      color: #a855f7;
      font-size: 13px;
    }
    .meta { color: #4a6382; font-size: 11px; margin-top: 6px; }
    .prompt-box {
      background: #0b1420;
      border: 1px solid #1e2d40;
      border-radius: 6px;
      padding: 12px;
      font-size: 11px;
      line-height: 1.5;
      color: #6b8299;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .raw-json {
      background: #0b1420;
      border: 1px solid #1e2d40;
      border-radius: 6px;
      padding: 12px;
      font-size: 11px;
      color: #8da4be;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #2a3f57;
      border-top-color: #f5c518;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box {
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 8px;
      padding: 12px;
      color: #ef4444;
      font-size: 13px;
    }
    .timing-bar {
      display: flex;
      gap: 20px;
      font-size: 12px;
      color: #6b8299;
      margin-top: 8px;
    }
    .timing-bar span { color: #8da4be; font-weight: 600; }
    details { margin-top: 8px; }
    details summary {
      cursor: pointer;
      color: #4a6382;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    details summary:hover { color: #8da4be; }
    #history { margin-top: 24px; }
    .history-item {
      border-left: 3px solid #2a3f57;
      padding: 8px 12px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #6b8299;
    }
    .history-item .hi-amps { color: #f5c518; font-weight: 700; font-size: 14px; }
    .history-item .hi-reason { color: #c0d0e0; font-style: italic; }
  </style>
</head>
<body>
  <h1>‚ö° AI Test Bench</h1>
  <p class="subtitle">Dry-run the Ollama AI pipeline with mock data. No commands are sent to Tesla.</p>

  <!-- Input Form -->
  <div class="section">
    <div class="section-title">Solax ‚Äî Solar & Grid</div>
    <div class="grid">
      <label>Solar Yield (W)<input type="number" id="solar_w" value="2800"></label>
      <label>Household Demand (W)<input type="number" id="household_w" value="900"></label>
      <label>Grid Import (W)<input type="number" id="grid_import_w" value="150"></label>
      <label>Home Battery SoC (%)<input type="number" id="battery_soc" value="65"></label>
      <label>Battery Power (W)<input type="number" id="battery_w" value="-200"></label>
      <label>Solar Trend
        <select id="solar_trend">
          <option value="rising" selected>Rising</option>
          <option value="stable">Stable</option>
          <option value="falling">Falling</option>
        </select>
      </label>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Tesla ‚Äî Car State</div>
    <div class="grid">
      <label>Tesla SoC (%)<input type="number" id="tesla_soc" value="55"></label>
      <label>Target SoC (%)<input type="number" id="target_soc" value="80"></label>
      <label>Current Amps (A)<input type="number" id="current_amps" value="10"></label>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Strategy & Budget</div>
    <div class="grid">
      <label>Charging Strategy
        <select id="charging_strategy">
          <option value="solar" selected>Solar-first</option>
          <option value="departure">Ready by Departure</option>
        </select>
      </label>
      <label>Departure Time<input type="text" id="departure_time" value="" placeholder="e.g. 07:00"></label>
      <label>Grid Budget Total (kWh)<input type="number" id="grid_budget_total_kwh" value="25"></label>
      <label>Grid Budget Used (kWh)<input type="number" id="grid_budget_used_kwh" value="5"></label>
      <label>Max Grid Import (W)<input type="number" id="max_grid_import_w" value="7000"></label>
      <label>Hours Until Sunset<input type="number" id="hours_until_sunset" value="5.5" step="0.1"></label>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Session Context</div>
    <div class="grid">
      <label>Session Elapsed (min)<input type="number" id="session_elapsed_mins" value="45"></label>
      <label>kWh Added<input type="number" id="session_kwh_added" value="3.2" step="0.1"></label>
      <label>Solar Subsidy (%)<input type="number" id="session_solar_pct" value="82"></label>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn-primary" id="runBtn" onclick="runTest()">Run AI Test</button>
    <button class="btn-secondary" onclick="randomize()">üé≤ Randomize</button>
    <button class="btn-secondary" onclick="presetPeakSolar()">‚òÄÔ∏è Peak Solar</button>
    <button class="btn-secondary" onclick="presetLowSolar()">üå•Ô∏è Low Solar</button>
    <button class="btn-secondary" onclick="presetDeparture()">üöó Departure Crunch</button>
    <button class="btn-secondary" onclick="presetBudgetCrunch()">üí∞ Budget Crunch</button>
    <button class="btn-danger" onclick="clearResults()">Clear</button>
  </div>

  <!-- Results -->
  <div id="results"></div>

  <!-- History -->
  <div id="history"></div>

<script>
const API_URL = window.location.origin + '/api/debug/ai-test';
const fields = [
  'solar_w','household_w','grid_import_w','battery_soc','battery_w','solar_trend',
  'tesla_soc','target_soc','current_amps',
  'charging_strategy','departure_time','grid_budget_total_kwh','grid_budget_used_kwh',
  'max_grid_import_w','hours_until_sunset',
  'session_elapsed_mins','session_kwh_added','session_solar_pct'
];
const history = [];

function getValues() {
  const data = {};
  fields.forEach(f => {
    const el = document.getElementById(f);
    const v = el.value;
    if (el.type === 'number') data[f] = parseFloat(v) || 0;
    else data[f] = v;
  });
  return data;
}

function setValues(data) {
  Object.entries(data).forEach(([k, v]) => {
    const el = document.getElementById(k);
    if (el) el.value = v;
  });
}

function rand(min, max) { return Math.round(min + Math.random() * (max - min)); }
function randF(min, max, dec=1) { return parseFloat((min + Math.random() * (max - min)).toFixed(dec)); }

function randomize() {
  const hour = new Date().getHours();
  const solarBase = hour >= 6 && hour <= 18 ? rand(200, 4500) : 0;
  setValues({
    solar_w: solarBase,
    household_w: rand(400, 1500),
    grid_import_w: rand(-500, 800),
    battery_soc: rand(10, 95),
    battery_w: rand(-500, 500),
    solar_trend: ['rising','stable','falling'][rand(0,2)],
    tesla_soc: rand(15, 90),
    target_soc: rand(60, 100),
    current_amps: rand(0, 24),
    charging_strategy: Math.random() > 0.5 ? 'solar' : 'departure',
    departure_time: Math.random() > 0.5 ? `${String(rand(5,9)).padStart(2,'0')}:00` : '',
    grid_budget_total_kwh: rand(10, 40),
    grid_budget_used_kwh: randF(0, 20),
    max_grid_import_w: rand(3000, 10000),
    hours_until_sunset: randF(0.5, 8),
    session_elapsed_mins: rand(5, 180),
    session_kwh_added: randF(0.5, 15),
    session_solar_pct: rand(20, 100),
  });
}

function presetPeakSolar() {
  setValues({
    solar_w: 4200, household_w: 750, grid_import_w: -300, battery_soc: 80,
    battery_w: -400, solar_trend: 'rising', tesla_soc: 45, target_soc: 80,
    current_amps: 12, charging_strategy: 'solar', departure_time: '',
    grid_budget_total_kwh: 25, grid_budget_used_kwh: 2, max_grid_import_w: 7000,
    hours_until_sunset: 6, session_elapsed_mins: 30, session_kwh_added: 2.5,
    session_solar_pct: 95,
  });
}

function presetLowSolar() {
  setValues({
    solar_w: 350, household_w: 900, grid_import_w: 600, battery_soc: 40,
    battery_w: 200, solar_trend: 'falling', tesla_soc: 62, target_soc: 80,
    current_amps: 8, charging_strategy: 'solar', departure_time: '',
    grid_budget_total_kwh: 25, grid_budget_used_kwh: 12, max_grid_import_w: 7000,
    hours_until_sunset: 2, session_elapsed_mins: 90, session_kwh_added: 6.1,
    session_solar_pct: 55,
  });
}

function presetDeparture() {
  setValues({
    solar_w: 1200, household_w: 800, grid_import_w: 400, battery_soc: 55,
    battery_w: 0, solar_trend: 'falling', tesla_soc: 52, target_soc: 90,
    current_amps: 10, charging_strategy: 'departure', departure_time: '07:00',
    grid_budget_total_kwh: 25, grid_budget_used_kwh: 8, max_grid_import_w: 7000,
    hours_until_sunset: 1.5, session_elapsed_mins: 120, session_kwh_added: 8.5,
    session_solar_pct: 60,
  });
}

function presetBudgetCrunch() {
  setValues({
    solar_w: 1800, household_w: 1000, grid_import_w: 500, battery_soc: 50,
    battery_w: 100, solar_trend: 'stable', tesla_soc: 58, target_soc: 80,
    current_amps: 14, charging_strategy: 'solar', departure_time: '',
    grid_budget_total_kwh: 10, grid_budget_used_kwh: 9.2, max_grid_import_w: 4000,
    hours_until_sunset: 4, session_elapsed_mins: 60, session_kwh_added: 5.0,
    session_solar_pct: 70,
  });
}

function clearResults() {
  document.getElementById('results').innerHTML = '';
}

async function runTest() {
  const btn = document.getElementById('runBtn');
  const resultsDiv = document.getElementById('results');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Calling Ollama...';
  resultsDiv.innerHTML = '<div style="color:#6b8299;padding:20px;">Waiting for Qwen response (typically 5‚Äì30 seconds)...</div>';

  const data = getValues();
  const startTime = Date.now();

  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ detail: resp.statusText }));
      throw new Error(err.detail || `HTTP ${resp.status}`);
    }

    const result = await resp.json();
    const p = result.pipeline;
    const t = result.timing;
    const rec = p['3_parsed_recommendation'];
    const cmd = p['4_tessie_command'];
    const msg = p['5_user_facing_message'];
    const confClass = `confidence-${rec.confidence}`;

    // Add to history
    history.unshift({
      time: new Date().toLocaleTimeString(),
      amps: rec.recommended_amps,
      confidence: rec.confidence,
      reasoning: rec.reasoning,
      strategy: data.charging_strategy,
      solar: data.solar_w,
      soc: `${data.tesla_soc}‚Üí${data.target_soc}%`,
    });

    resultsDiv.innerHTML = `
      <!-- AI Decision -->
      <div class="result-card highlight">
        <div class="result-label">AI Decision</div>
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
          <div class="result-value amps">${rec.recommended_amps}A</div>
          <div class="result-value ${confClass}" style="font-size:14px;">${rec.confidence.toUpperCase()} confidence</div>
        </div>
        <div class="reasoning">"${rec.reasoning}"</div>
        <div class="timing-bar">
          <div>Response: <span>${t.ollama_response_secs}s</span></div>
          <div>Model: <span>${t.model}</span></div>
          <div>Host: <span>${t.host}</span></div>
        </div>
      </div>

      <!-- Tessie Command -->
      <div class="result-card command">
        <div class="result-label">Tessie Command (Dry Run)</div>
        <div class="command-text">
          <strong>${cmd.action}</strong> ‚Üí ${cmd.amps}A
        </div>
        <div class="meta">${cmd.endpoint}</div>
        <div class="meta" style="color:#f59e0b;">${cmd.note}</div>
      </div>

      <!-- User Banner Preview -->
      <div class="result-card banner">
        <div class="result-label">User-Facing Banner (as shown in app)</div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
          <span style="font-size:13px;color:#a855f7;font-weight:700;">ü§ñ AI Optimizing</span>
          <span style="font-size:12px;padding:2px 8px;border-radius:10px;background:rgba(245,158,11,0.1);color:#f59e0b;border:1px solid rgba(245,158,11,0.2);">${rec.confidence} confidence</span>
        </div>
        <div style="font-size:15px;font-weight:700;color:#f5c518;margin-bottom:4px;">${rec.recommended_amps}A</div>
        <div class="reasoning">"${msg.banner_text}"</div>
      </div>

      <!-- Collapsible: Raw Ollama Response -->
      <details>
        <summary>Raw Ollama Response</summary>
        <div class="raw-json" style="margin-top:8px;">${p['2_ollama_raw_response']}</div>
      </details>

      <!-- Collapsible: Full Prompt -->
      <details>
        <summary>Full Prompt Sent</summary>
        <div class="prompt-box" style="margin-top:8px;">${escapeHtml(p['1_prompt_sent'])}</div>
      </details>

      <!-- Input Summary -->
      <details>
        <summary>Input Parameters</summary>
        <div class="raw-json" style="margin-top:8px;">${JSON.stringify(data, null, 2)}</div>
      </details>
    `;

    renderHistory();

  } catch (err) {
    resultsDiv.innerHTML = `<div class="error-box">Error: ${escapeHtml(err.message)}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Run AI Test';
  }
}

function renderHistory() {
  if (history.length === 0) return;
  const div = document.getElementById('history');
  div.innerHTML = `
    <div class="section-title">Test History (${history.length})</div>
    ${history.map(h => `
      <div class="history-item">
        <span style="color:#4a6382;">${h.time}</span>
        <span class="hi-amps">${h.amps}A</span>
        <span style="color:#6b8299;">${h.confidence}</span>
        <span style="color:#4a6382;">| ${h.strategy} | ‚òÄÔ∏è${h.solar}W | üîã${h.soc}</span>
        <br><span class="hi-reason">"${h.reasoning}"</span>
      </div>
    `).join('')}
  `;
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
